<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Flipagram 涂鸦特效逆向分析</title>
    <meta name="description" content="  背景  Flipagram特效  仿涂鸦特效">

    <link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_8v3czwksspqlg14i.css">
    <link rel="stylesheet" href="/css/main.css ">
    <link rel="canonical" href="http://MelonTeam.com/posts/flipagram_tu_ya_te_xiao_ni_xiang_fen_xi/">
    <link rel="alternate" type="application/rss+xml" title="MelonTeam" href="http://MelonTeam.com/feed.xml ">



</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/" class="brand">MelonTeam</a>
        <small>移动终端前沿技术的探索者</small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/">
                    
                        <i class="fa fa-home"></i>首页
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/project/">
                        
                            <i class="fa fa-folder-open"></i>开源项目
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/class/">
                        
                            <i class="fa fa-book"></i>公开课
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>分类
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/board/">
                        
                            <i class="fa fa-pencil"></i>留言板
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" post>
    <div class="left">
        <h1>Flipagram 涂鸦特效逆向分析</h1>
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2017-05-27
            </div>
            
            <div class="label-card">
                <i class="fa fa-user"></i>qingduan
            </div>
            
            
            
            <div class="label-card">
            




<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#ios" title="Category: ios" rel="category">ios</a>
    
  

  <!-- <span class="point">•</span> -->
</span>



            </div>
            
            
            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#%E6%B6%82%E9%B8%A6%E7%B2%92%E5%AD%90..." title="Tag: 涂鸦粒子..." rel="tag">涂鸦粒子...</a-->
        <a href="/tag/#涂鸦粒子..." title="Tag: 涂鸦粒子..." rel="tag">涂鸦粒子...</a>
    
  

</span>



            </div>
            

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <ul id="markdown-toc">
  <li><a href="#section" id="markdown-toc-section">背景</a></li>
  <li><a href="#flipagram" id="markdown-toc-flipagram">Flipagram特效</a></li>
  <li><a href="#section-1" id="markdown-toc-section-1">仿涂鸦特效</a>    <ul>
      <li><a href="#ios" id="markdown-toc-ios">IOS粒子效果</a></li>
      <li><a href="#flipagram-1" id="markdown-toc-flipagram-1">Flipagram特效参数分析</a></li>
    </ul>
  </li>
  <li><a href="#section-2" id="markdown-toc-section-2">逆向分析</a>    <ul>
      <li><a href="#ui" id="markdown-toc-ui">UI层级分析</a></li>
      <li><a href="#section-3" id="markdown-toc-section-3">相关类</a></li>
      <li><a href="#section-4" id="markdown-toc-section-4">小结</a></li>
    </ul>
  </li>
  <li><a href="#section-5" id="markdown-toc-section-5">后续工作</a></li>
</ul>

<ul>
  <li>背景</li>
  <li>Flipagram特效</li>
  <li>仿涂鸦特效<br />
<!--more-->
    <ul>
      <li>IOS粒子效果</li>
      <li>Flipagram特效参数分析</li>
    </ul>
  </li>
  <li>逆向分析
    <ul>
      <li>UI层级分析</li>
      <li>相关类</li>
      <li>小结</li>
    </ul>
  </li>
  <li>后续工作</li>
</ul>

<h2 id="section">背景</h2>

<p>Flipagram是美国一款非常火爆的短视频应用，一度登顶美国appstore榜首。前段时间又被今日头条重金收购，被当做今日头条发展海外短视频、提升国际影响力的发力点。本着好奇的心情体验了一下这款APP，印象最深的是视频编辑能力比较强，特别是动态涂鸦效果感觉非常惊艳，打算好好研究一下，优化改进一下手Q现有的涂鸦效果。</p>

<h2 id="flipagram">Flipagram特效</h2>

<p><img src="/image/flipagram_tu_ya_te_xiao_ni_xiang_fen_xi/a658c5552ff00982a62844332c5ebb83852d4e45677ad42d5f984767987e6e2f" alt="Untitled" /></p>

<h2 id="section-1">仿涂鸦特效</h2>

<p>初步推测：系统自带的粒子效果+手势，在手指移动的过程中创建不同效果的粒子发射机，粒子发射机发射不同效果的粒子。</p>

<h3 id="ios">IOS粒子效果</h3>

<p>系统自带的粒子效果实现主要的类是：<code>CAEmitterBehavior</code>、<code>CAEmitterLayer</code>、<code>CAEmitterCell</code>他们的作用分别是，定义粒子发射机的行为、设置发射机的特征、设置粒子的具体特效。</p>

<p>使用比较简单：</p>

<pre><code>    //Create the root layer
    rootLayer = [CALayer layer];

    //Set the root layer's attributes
    rootLayer.bounds = CGRectMake(0, 0, 640, 480);
    CGColorRef color = CGColorCreateGenericRGB(0.0, 0.0, 0.0, 1);
    rootLayer.backgroundColor = color;
    CGColorRelease(color);

    //Load the spark image for the particle
    NSImage *image = [NSImage imageNamed:@"tspark"];
    CGImageRef img = [image CGImageForProposedRect:nil context:nil hints:nil];

    mortor = [CAEmitterLayer layer];
    mortor.emitterPosition = CGPointMake(320, 0);
    mortor.renderMode = kCAEmitterLayerAdditive;

    //Invisible particle representing the rocket before the explosion
    CAEmitterCell *rocket = [CAEmitterCell emitterCell];
    rocket.emissionLongitude = M_PI / 2;
    rocket.emissionLatitude = 0;
    rocket.lifetime = 1.6;
    rocket.birthRate = 1;
    rocket.velocity = 400;
    rocket.velocityRange = 100;
    rocket.yAcceleration = -250;
    rocket.emissionRange = M_PI / 4;
    color = CGColorCreateGenericRGB(0.5, 0.5, 0.5, 0.5);
    rocket.color = color;
    CGColorRelease(color);
    rocket.redRange = 0.5;
    rocket.greenRange = 0.5;
    rocket.blueRange = 0.5;

    //Name the cell so that it can be animated later using keypath
    rocket.name = @"rocket";

    //Flare particles emitted from the rocket as it flys
    CAEmitterCell *flare = [CAEmitterCell emitterCell];
    flare.contents = (__bridge id)img;
    flare.emissionLongitude = (4 * M_PI) / 2;
    flare.scale = 0.4;
    flare.velocity = 100;
    flare.birthRate = 45;
    flare.lifetime = 1.5;
    flare.yAcceleration = -350;
    flare.emissionRange = M_PI / 7;
    flare.alphaSpeed = -0.7;
    flare.scaleSpeed = -0.1;
    flare.scaleRange = 0.1;
    flare.beginTime = 0.01;
    flare.duration = 0.7;

    //The particles that make up the explosion
    CAEmitterCell *firework = [CAEmitterCell emitterCell];
    firework.contents = (__bridge id)img;
    firework.birthRate = 9999;
    firework.scale = 0.6;
    firework.velocity = 130;
    firework.lifetime = 2;
    firework.alphaSpeed = -0.2;
    firework.yAcceleration = -80;
    firework.beginTime = 1.5;
    firework.duration = 0.1;
    firework.emissionRange = 2 * M_PI;
    firework.scaleSpeed = -0.1;
    firework.spin = 2;

    //Name the cell so that it can be animated later using keypath
    firework.name = @"firework";

    //preSpark is an invisible particle used to later emit the spark
    CAEmitterCell *preSpark = [CAEmitterCell emitterCell];
    preSpark.birthRate = 80;
    preSpark.velocity = firework.velocity * 0.70;
    preSpark.lifetime = 1.7;
    preSpark.yAcceleration = firework.yAcceleration * 0.85;
    preSpark.beginTime = firework.beginTime - 0.2;
    preSpark.emissionRange = firework.emissionRange;
    preSpark.greenSpeed = 100;
    preSpark.blueSpeed = 100;
    preSpark.redSpeed = 100;

    //Name the cell so that it can be animated later using keypath
    preSpark.name = @"preSpark";

    //The 'sparkle' at the end of a firework
    CAEmitterCell *spark = [CAEmitterCell emitterCell];
    spark.contents = (__bridge id)img;
    spark.lifetime = 0.05;
    spark.yAcceleration = -250;
    spark.beginTime = 0.8;
    spark.scale = 0.4;
    spark.birthRate = 10;

    preSpark.emitterCells = @[spark];
    rocket.emitterCells = @[flare, firework, preSpark];
    mortor.emitterCells = @[rocket];
    [rootLayer addSublayer:mortor];

    //Set the view's layer to the base layer
    theView.layer = rootLayer;
    [theView setWantsLayer:YES];

    //Force the view to update
    [theView setNeedsDisplay:YES];
</code></pre>

<p>具体效果：  <br />
<img src="/image/flipagram_tu_ya_te_xiao_ni_xiang_fen_xi/92e77db926e37e4048d8d52e9e340ea5f0a840b874a371e2b016a5f53ef85ba9" alt="Untitled1" /></p>

<h3 id="flipagram-1">Flipagram特效参数分析</h3>

<p>粒子效果的参数非常多，要实现和Flipagram一样的效果，设置参数是一件非常繁琐的事情，借用粒子效果的工具分析了一种类似效果的具体参数，主要包含4个方面的参数：发射机、粒子、色彩、纹理  <br />
16个发射机参数(截取部分显示)：  <br />
<img src="/image/flipagram_tu_ya_te_xiao_ni_xiang_fen_xi/2fe6c2862e10ae1f4c1a9eebfbbe85db8fb321bd2dfbf6c7534c0a22e2f58f9d" alt="屏幕快照 2017-04-28
下午2.05.28" /></p>

<p>10个粒子参数(截取部分显示)：  <br />
<img src="/image/flipagram_tu_ya_te_xiao_ni_xiang_fen_xi/472680555b4c18e282bdb26fe5458ee6b8836c878ebcb5314ba5bd47b8b2be01" alt="屏幕快照 2017-04-28
下午2.05.39" /></p>

<p>12个色彩参数(截取部分显示)：  <br />
<img src="/image/flipagram_tu_ya_te_xiao_ni_xiang_fen_xi/b8008c75a6fc39919a88daac1a678a9b06281c5000babb29abaa26429f2754a9" alt="屏幕快照 2017-04-28
下午2.05.46" /></p>

<p>纹理设置：  <br />
<img src="/image/flipagram_tu_ya_te_xiao_ni_xiang_fen_xi/d65415b4f3fa5a956b979931f29259456344a9383c027e54dbf816daa55e6e40" alt="屏幕快照 2017-04-28
下午2.05.53" /></p>

<p><strong>小结：通过类似粒子效果的参数分析，发现系统接口的参数比较少，根本实现不了这种稍微复杂一点的效果。</strong></p>

<h2 id="section-2">逆向分析</h2>

<h3 id="ui">UI层级分析</h3>

<p>通过分析Flipagram的涂鸦页面的UI层级，发现和涂鸦渲染层的类是<code>FGDrawControlsView</code>  <br />
<img src="/image/flipagram_tu_ya_te_xiao_ni_xiang_fen_xi/39a67b431717fbf92b7b7f943c689f422eb6f782eeedb2c5ad7b23f955c3b6bc" alt="708FF504-D266-4C76-A31A-
E75094AAE585" /></p>

<h3 id="section-3">相关类</h3>

<p>通过反汇编分析了和渲染层<code>FGDrawControlsView</code>相关的主要类：<code>FGDrawEnginePathFactory</code>、<code>FGDrawEnginePath</code>、<code>FGDrawEngine</code>  <br />
<img src="/image/flipagram_tu_ya_te_xiao_ni_xiang_fen_xi/c59271ab58e5f8f9934b2b7a817602d27e87ee1c8ddd2a65eab9a973c6251f1d" alt="056C8FF2-D711-4FAA-BA7F-
8451A4C8966D" /></p>

<p><code>FGDrawEnginePathFactory</code>是一个负责创建具体特效路径的工厂类，比如：烟花效果的路径、不同画刷的路径、表情效果的路径、沙子效果的路径等等。<br />
<code>FGDrawEnginePath</code>设置粒子发射机的特性和粒子特效参数，比如：颜色、画刷参数、弧度等，同时维护了一条路径的矢量点阵信息。<br />
<code>FGDrawEngine</code>内部利用了OpenGL把发射机参数、粒子效果参数、色彩参数、纹理参数的具体效果渲染出来。</p>

<h3 id="section-4">小结</h3>

<p><code>IOS</code>自带的粒子效果使用比较简单，但是效果也比较单一，很难实现酷炫的效果。<code>Flipagram</code>的涂鸦特效实现是在手指移动的过程中创建不同效果的粒子发射机，粒子发射机发射不同效果的粒子。其中<code>FGDrawEnginePath</code>主要负责管理路径和特效信息，<code>FGDrawEngine</code>负责渲染具体的效果。</p>

<h2 id="section-5">后续工作</h2>

<p>继续分析<code>FGDrawEngine</code>的内部接口，利用<code>OpenGL</code>实现一个粒子特效引擎，最终实现<code>Flipagram</code>的涂鸦特效。</p>


        </article>
        <hr>

        
        
            
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
        
            
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
        
        

        <div class="post-recent">
    <div class="pre">
        
        <p><strong>上一篇</strong> <a href="/posts/kai_fa_zhong_rong_yi_hu_lve_he_wa_keng_de_chang_jing_zong_jie/">开发中容易忽略和挖坑的场景总结</a></p>
        
    </div>
    <div class="nex">

        
        <p><strong>下一篇</strong> <a href="/posts/guan_yu_gpuimage/">关于GPUImage</a></p>
        
    </div>
</div>


        <h2 id="comments">说一说</h2>
        

<!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript">
var uyan_config = {
     'url':'http://MelonTeam.com/posts/flipagram_tu_ya_te_xiao_ni_xiang_fen_xi/',
     'du':'http://MelonTeam.com', 
     'su':'http://MelonTeam.com/posts/flipagram_tu_ya_te_xiao_ni_xiang_fen_xi/' 
};
</script>
<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2136610"></script>
<!-- UY END -->






    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    目录
                </div>
                <ul id="content-side" class="content-ul">
                    
                    <li><a href="#comments">说一说</a></li>
                </ul>
            </div>
            <!-- 其他div框放到这里 -->
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


    <div class="wrapper">

        <p class="description">
            
        </p>
        <p class="power">
            <span>
                Copyright © 2017 <a href="https://github.com/MelonTeam" title="GitHub">MelonTeam <i class="fa fa-github" aria-hidden="true"></i></a>. All Rights Reserved.
            </span>
        </p>
    </div>
</footer>


<script type="text/javascript" src="http://tajs.qq.com/stats?sId=62569168" charset="UTF-8"></script>



    <div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script>
    <script type="text/javascript">
      smoothScroll.init({
        speed: 500, // Integer. How fast to complete the scroll in milliseconds
        easing: 'easeInOutCubic', // Easing pattern to use
        offset: 20, // Integer. How far to offset the scrolling anchor location in pixels
      });
    </script>
  </body>

</html>
