<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>make wechat great again</title>
    <meta name="description" content="  工欲善其事必先利其器手机无需越狱，项目 github 地址: fishchat，make wechat great again！工欲善其事必先利其器因为没有越狱手机，所以不是直接写 tweak 放手机里，而是需要将 captainhook 工程编译出的 dylib 注入到已砸壳 app 的二进制文件中。同样因...">

    <link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_8v3czwksspqlg14i.css">
    <link rel="stylesheet" href="/css/main.css ">
    <link rel="canonical" href="http://MelonTeam.com/2017/05/25/make_wechat_great_again/">
    <link rel="alternate" type="application/rss+xml" title="MelonTeam" href="http://MelonTeam.com/feed.xml ">



</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/" class="brand">MelonTeam</a>
        <small>移动终端前沿技术的探索者</small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/opensource/">
                        
                            <i class="fa fa-folder-open"></i>开源项目
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>归档
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>分类
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tag/">
                        
                            <i class="fa fa-tags"></i>标签
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/board/">
                        
                            <i class="fa fa-pencil"></i>留言板
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" post>
    <div class="left">
        <h1>make wechat great again</h1>
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2017-05-25
            </div>
            
            <div class="label-card">
                <i class="fa fa-user"></i>rebootyang
            </div>
            
            
            
            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#ios" title="Category: ios" rel="category">ios</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>
            
            
            <div class="label-card">
            
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#%E5%BE%AE%E4%BF%A1" title="Tag: 微信" rel="tag">微信</a-->
        <a href="/tag/#微信" title="Tag: 微信" rel="tag">微信</a>&nbsp;
    
        <!--a href="/tag/#ios" title="Tag: ios" rel="tag">ios</a-->
        <a href="/tag/#ios" title="Tag: ios" rel="tag">ios</a>
    
  

</span>

            </div>
            

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <ul id="markdown-toc">
  <li><a href="#a-name-classreference-link" id="markdown-toc-a-name-classreference-link"><a name="工欲善其事必先利其器" class="reference-link"></a>工欲善其事必先利其器</a>    <ul>
      <li><a href="#a-name----classreference-link---" id="markdown-toc-a-name----classreference-link---"><a name="关闭『发现』页面的各种入口 - 清君侧" class="reference-link"></a>关闭『发现』页面的各种入口 - 清君侧</a></li>
      <li><a href="#a-name----classreference-link----1" id="markdown-toc-a-name----classreference-link----1"><a name="修改微信运动步数 - 装逼党的自我修养" class="reference-link"></a>修改微信运动步数 - 装逼党的自我修养</a></li>
      <li><a href="#a-name----classreference-link----2" id="markdown-toc-a-name----classreference-link----2"><a name="小红点消除计划 - 我想静静" class="reference-link"></a>小红点消除计划 - 我想静静</a></li>
      <li><a href="#a-name----classreference-link----3" id="markdown-toc-a-name----classreference-link----3"><a name="夜间模式 - 辣眼睛" class="reference-link"></a>夜间模式 - 辣眼睛</a></li>
      <li><a href="#a-name----classreference-link----4" id="markdown-toc-a-name----classreference-link----4"><a name="阻止撤回消息 - 知道真相的我眼泪掉下来" class="reference-link"></a>阻止撤回消息 - 知道真相的我眼泪掉下来</a></li>
      <li><a href="#a-name----classreference-link----5" id="markdown-toc-a-name----classreference-link----5"><a name="要屏蔽 - 不要免打扰" class="reference-link"></a>要屏蔽 - 不要免打扰</a></li>
    </ul>
  </li>
  <li><a href="#a-name-classreference-link-1" id="markdown-toc-a-name-classreference-link-1"><a name="后记" class="reference-link"></a>后记</a></li>
</ul>

<p><strong>手机无需越狱</strong>，项目 github 地址: <a href="https://github.com/yulingtianxia/fishchat">fishchat</a>，make wechat great again！</p>

<h2 id="a-name-classreference-link"><a name="工欲善其事必先利其器" class="reference-link"></a>工欲善其事必先利其器</h2>

<p>因为没有越狱手机，所以不是直接写 tweak 放手机里，而是需要将 <code>captainhook</code> 工程编译出的 dylib 注入到已砸壳 app 的二进制文件中。同样因为没有越狱机，所以砸壳的文件只能从 某 p 助手下载了。</p>

<p>我写了一个 shell 脚本 <a href="https://github.com/yulingtianxia/fishchat/blob/master/shell/autoswimfi.sh">autoswimfi.sh</a> 帮我完成一些重复性的任务：<br />
1. 查找可用的 iphone 开发者证书1. 解压 ipa 文件1. 拷贝 mobileprovision 文件和要注入的 dylib 文件到 app 文件夹中1. 向 app 中可执行文件的 <code>load commands</code> 段中加入一条加载 dylib 的指令1. 对 app 中所有的 app，appx，framework，dylib 文件用第 1 步获取的证书进行重签名1. 打包签名好的 ipa 文件1. 删除上述过程中产生的中间文件1. 通过 usb 线安装 ipa 文件手机上<br />
<a href="https://github.com/yulingtianxia/fishchat/blob/master/shell/autoswimfi.sh">autoswimfi.sh</a> 需要传入的三个参数分别为：已砸壳的 ipa 文件，没过期的 mobileprovision 文件，要注入的 dylib 文件。</p>

<!--more-->

<p>犹豫了很久，还是贴上脚本代码，壮气势充篇幅吧。</p>

<pre><code># !/bin/bash

sourceipa="$1"

mobileprov="$2"

dylib="$3"



cd ${sourceipa%/*}



security find-identity -v -p codesigning &gt; cers.txt

while ifs='' read -r line || [[ -n "$line" ]]; do

    if [[ "$line" =~ "iphone developer" ]]; then

      developer=${line:47:${#line}-48}

    fi

done &lt; cers.txt



unzip -qo "$sourceipa" -d extracted



application=$(ls extracted/payload/)



echo "copying dylib and mobileprovision"

cp "$dylib" "extracted/payload/$application/${dylib##*/}"

cp "$mobileprov" "extracted/payload/$application/embedded.mobileprovision"



echo "insert dylib into mach-o file"

yololib "extracted/payload/$application/${application%.*}" "${dylib##*/}"



echo "resigning with certificate: $developer"

find -d extracted  \( -name "*.app" -o -name "*.appex" -o -name "*.framework" -o -name "*.dylib" \) &gt; directories.txt

security cms -d -i "extracted/payload/$application/embedded.mobileprovision" &gt; t_entitlements_full.plist

/usr/libexec/plistbuddy -x -c 'print:entitlements' t_entitlements_full.plist &gt; t_entitlements.plist

while ifs='' read -r line || [[ -n "$line" ]]; do

    /usr/bin/codesign --continue -f -s "$developer" --entitlements "t_entitlements.plist"  "$line"

done &lt; directories.txt



echo "creating the signed ipa"

cd extracted

zip -qry ../extracted.ipa *

cd ..



rm -rf "extracted"

rm directories.txt

rm cers.txt

rm t_entitlements.plist

rm t_entitlements_full.plist



echo "installing app to your ios device"

mobiledevice install_app extracted.ipa


</code></pre>

<p>想要让 <a href="https://github.com/yulingtianxia/fishchat/blob/master/shell/autoswimfi.sh">autoswimfi.sh</a> 一气呵成执行下去，需要依赖以下几项：<br />
1. mac 上需要有唯一可用的 iphone 开发者证书，如果有多个，默认选最后一个1. <code>yololib</code> 工具用于注入 dylib 文件到二进制文件中1. <code>mobiledevice</code> 可以将 ipa 安装到 usb 连接到 mac 上的手机中1. 一个可用的 mobileprovision 文件，十分关键，可以新建个工程在自己手机 run 一下，新生成的 app 里面就有 mobileprovision 文件。<br />
在这里多再说几句：<br />
1. 一年多前我尝试安装 <code>iosopendev</code> 很多次，一直失败，就当前辈们劝我还是用 <code>theos</code> 稳妥的时候，我觉得还是再试一次吧，果然还是失败了。不过新建 xcode 项目选择 template 时却出现了 <code>iosopendev</code> 哈哈哈哈！1. 一开始用 <code>insert_dylib</code> 注入 dylib 后 crash，后来用 <code>yololib</code> 就好了！不过 <code>yololib</code> 有个 bug 是对 dylib 的版本号有要求。这里可以直接改源码，把 <code>dylib_current_ver</code> 和 <code>dylib_compatibility_version</code> 的宏定义都改成 <code>0x0000</code>。懒人直接用我上传的 <a href="https://github.com/yulingtianxia/fishchat/blob/master/yololib">yololib</a>。1. 如果要查看 mach-o 文件完整信息，建议用 machoview。<code>otool -l</code> 打印所有的 <code>load commands</code>，建议搭配 <code>grep</code> 进行正则过滤。<code>otool -l</code> 可以查看使用的库文件。1. 网上一些重签名工具没有将插件拓展或 watch 中的 dylib 重签名，导致签名失败等问题。微信的 apple watch 客户端用 swift 写的，因为还没有 abi 稳定，所以只好把大量 dylib 打包进去。1. 可以使用 <code>cycript</code> 来完成一些调试工作，这样就不用一次次打 log 了。同样也可以打印出视图层级，不过建议有条件的同学用 reveal 2，已经支持 usb 调试了。<code>cycript</code> 只支持在同网段下连接到手机 ip 的 <code>8888</code> 端口，cy 脚本还是跟 <code>lldb</code> 命令有一些差别的。如果 <code>cycript</code> 官网的 sdk 不好用，那就用用我上传的吧：<a href="https://github.com/yulingtianxia/fishchat/tree/master/cycript.framework"><code>cycript.framework</code></a>1. 找到视图对应的类之后，就需要在 <code>class-dump</code> 得到的头文件寻找蛛丝马迹了。dump 出的文件：<a href="https://github.com/yulingtianxia/fishchat/tree/master/wechat-headers">wechat-headers</a>1. 查看设备 log 最简单的方式当然是从 xcode-&gt;devices-&gt;你的设备。 1. 安装时如果遇到 <code>amdevicesecureinstallapplication</code> 安装失败，可以将工程 clean 和 clean build folder 后重新编译，再跑一次我的脚本。如果还不行，尝试用 itools 等软件安装 ipa 到手机上。<br />
## <a name="之后就是不停地 hook" class="reference-link"></a>之后就是不停地 hook</p>

<p>我曾经在『<a href="http://yulingtianxia.com/blog/2016/05/06/let-your-wechat-for-mac-never-revoke-messages/">让你的微信不再被人撤回消息</a>』这篇文章中说过：</p>

<blockquote>

</blockquote>

<p>之前看的一些逆向的教程里，感觉前期工作都是装软件配环境，噼里啪啦命令一顿敲，整的挺玄乎，其实都是用人家现成儿的工具做些事情，美其名曰『站在巨人的肩膀上』，这里不再赘述。在我看来第一个真正意义上有难度的事情就是一个字儿：『猜』！</p>

<p>是啊，头文件有了，ui 层级有了，该猜了！那么检验是否猜对需要做啥？hook 呗！<code>captainhook</code> 的用法很简单，新建工程的模板注释里面已经写得很详细了，就不赘述了。</p>

<blockquote>

</blockquote>

<p>mac 上需要安装 <code>iosopendev</code> 或 <code>theos</code>，本项目新建工程时使用 <code>iosopendev</code> 的 <code>captainhook</code> 模板。编译的时候要选自己的手机，不要选模拟器。</p>

<h3 id="a-name----classreference-link---"><a name="关闭『发现』页面的各种入口 - 清君侧" class="reference-link"></a>关闭『发现』页面的各种入口 - 清君侧</h3>

<p>在关掉各种乱码七糟的功能之后，发现页面仍留下几个无法关闭的入口。本次逆向微信的动机也由此引发：我只想关闭朋友圈入口，并没想关闭自己朋友圈内容，不过微信的这项策略也是很符合一些人的需求的。很多人真的想关闭自己朋友圈不让别人看，不过将这个需求跟旧的『关闭朋友圈入口』功能强绑定在一起，就有些绑架用户的味道了，鱼和熊掌不可兼得啊！不过关闭朋友圈后，别人依然能看到自己在 timeline 上新发的内容，但是一旦点击头像进入主页后就提示『该朋友暂未开启朋友圈』，奇怪的是回到自己的 timeline 上后，以前那条新发的内容就消失了。我觉得这不是 bug，而是产品策略。微信在努力保持用户粘性，不得不在用户需求和产品数据之间权衡。好吧，扯远了。。。</p>

<p>我只保留了这俩『活儿好不粘人』的工具类入口：</p>

<p><img src="/image/make_wechat_great_again/2164e4e62516adbc21d95499bc60fda7f6767100bb8c36e18d52cffa1d3aa7c5" alt="" /></p>

<p>其实扫一扫页面可以通过右上角加号更快进入，也可以去掉。小程序其实平时也基本不用，偶尔用的时候现搜，鸡肋入口。不能再干掉了，否则还不如索性干掉整个发现页面。</p>

<p>删入口有两种思路，一种是删数据源，另一种是 hook <code>uitableviewdelegate</code> 和 <code>uitableviewdatasource</code>。发现页面的 vc 是 <code>findfriendentryviewcontroller</code>，发现数据源数组包含的结构体需要花功夫猜下含义，索性简单粗暴 plan b。</p>

<pre><code>// 关闭朋友圈入口

choptimizedmethod2(self, cgfloat, findfriendentryviewcontroller, tableview, uitableview *, tableview, heightforrowatindexpath, nsindexpath *, indexpath)

{

    nsindexpath *timelineindexpath = [self valueforkeypath:@"m_wctimelineindexpath"];

    if ([indexpath isequal: timelineindexpath] || indexpath.section == 2) {

        nslog(@"## hide time line entry ##");

        return 0;

    }

    return chsuper2(findfriendentryviewcontroller, tableview, tableview, heightforrowatindexpath, indexpath);

}



choptimizedmethod2(self, uitableviewcell *, findfriendentryviewcontroller, tableview, uitableview *, tableview, cellforrowatindexpath, nsindexpath *, indexpath)

{

    nsindexpath *timelineindexpath = [self valueforkeypath:@"m_wctimelineindexpath"];

    uitableviewcell *cell = chsuper2(findfriendentryviewcontroller, tableview, tableview, cellforrowatindexpath, indexpath);

    if ([indexpath isequal: timelineindexpath] || indexpath.section == 2) {

        nslog(@"## hide time line entry ##");

        cell.hidden = yes;

        for (uiview *subview in cell.subviews) {

            [subview removefromsuperview];

        }

    }

    return cell;

}


</code></pre>

<p>简单粗暴地将想要隐藏的入口 cell 高度设为 <code>0</code> 后发现 <code>subview</code> 被挤出来了，我日，只好再干掉这些 <code>subview</code>。最后记得在页面出现时刷新下 table 数据：</p>

<pre><code>choptimizedmethod1(self, void, findfriendentryviewcontroller, viewdidappear, bool, animated)

{

    chsuper1(findfriendentryviewcontroller, viewdidappear, animated);

    [self performselector:@selector(reloaddata)];

}


</code></pre>

<h3 id="a-name----classreference-link----1"><a name="修改微信运动步数 - 装逼党的自我修养" class="reference-link"></a>修改微信运动步数 - 装逼党的自我修养</h3>

<p>修改微信运动步数的方法网上一搜就有好多文章，就是 hook <code>wcdevicestepobject</code> 的 <code>m7stepcount</code> 方法罢了。我在这里为了更方便地装逼，当然不能 hook 时把步数写死了，随机数也不够屌，要装逼就装到位：</p>

<p>先到设置页面：</p>

<p><img src="/image/make_wechat_great_again/042007a520fc38a4b6d53b50263b5f90ecdc18f01aa9fa82ed853954ee5da5a0" alt="" /></p>

<p>在文本框输入个正数：</p>

<p><img src="/image/make_wechat_great_again/8a7a0dfb2f3e6103afc98320d84f641aef7a6598f0a9b043cb379178bc3430b5" alt="" /></p>

<p>完美：</p>

<p><img src="/image/make_wechat_great_again/bf30eb035365a9b978a8fdb72fb4f7ffb85f0b0ab19f59556dcdb7a1d8e8aa1f" alt="" /></p>

<blockquote>

</blockquote>

<p><strong>==我就问你怕不怕==</strong></p>

<p>微信的一些列表页面是由数据来驱动 ui 的。table 对应 <code>mmtableviewinfo</code>，section 对应 <code>mmtableviewsectioninfo</code>，cell 对应 <code>mmtableviewcellinfo</code>。以前做项目时也见到过类似的框架，理解起来不难。但是这种过度的封装完全改变了原有系统 api，使用者碰到问题需要深入到框架去调试，又因为是内部框架，网上也搜不到方案。所以要求框架作者规范的编码习惯和较强的能力。又扯远了，我是用 <code>fishconfigurationcenter</code> 这个单例类来保存状态值的，目前还没在持久层写入磁盘。可以在 <code>mmtableviewcellinfo</code> 头文件看到微信中常用的 cell 是封装好的，这里直接获取个带文本框的就行了。我顺便还加了个夜间模式的开关 cell：</p>

<pre><code>chdeclaremethod0(void, newsettingviewcontroller, reloadtabledata)

{

    chsuper0(newsettingviewcontroller, reloadtabledata);

    mmtableviewinfo *tableinfo = [self valueforkeypath:@"m_tableviewinfo"];

    mmtableviewsectioninfo *sectioninfo = [objc_getclass("mmtableviewsectioninfo") sectioninfodefaut];

    mmtableviewcellinfo *nightcellinfo = [objc_getclass("mmtableviewcellinfo") switchcellforsel:@selector(handlenightmode:) target:[fishconfigurationcenter sharedinstance] title:@"夜间模式" on:[fishconfigurationcenter sharedinstance].isnightmode];

    [sectioninfo addcell:nightcellinfo];

    mmtableviewcellinfo *stepcountcellinfo = [objc_getclass("mmtableviewcellinfo") editorcellforsel:@selector(handlestepcount:) target:[fishconfigurationcenter sharedinstance] tip:@"请输入步数" focus:no text:[nsstring stringwithformat:@"%ld", (long)[fishconfigurationcenter sharedinstance].stepcount]];

    [sectioninfo addcell:stepcountcellinfo];

    [tableinfo insertsection:sectioninfo at:0];

    mmtableview *tableview = [tableinfo gettableview];

    [tableview reloaddata];

}


</code></pre>

<p>然后获取步数的时候从单例里取值就可以啦：</p>

<pre><code>// 微信运动步数

choptimizedmethod0(self, unsigned int, wcdevicestepobject, m7stepcount)

{

    if ([fishconfigurationcenter sharedinstance].stepcount == 0) {

        [fishconfigurationcenter sharedinstance].stepcount = chsuper0(wcdevicestepobject, m7stepcount);

    }

    return [fishconfigurationcenter sharedinstance].stepcount;

}


</code></pre>

<h3 id="a-name----classreference-link----2"><a name="小红点消除计划 - 我想静静" class="reference-link"></a>小红点消除计划 - 我想静静</h3>

<p>微信真的是越来越臃肿，大有追赶 qq 的架势，连小红点也是越来越多。『发现』页面撸的挺干净了，我就不信扫一扫入口还能有小红点（flag 已立）。『我』tab 页里什么钱包啊卡包啊老有小红点，真烦人，老得点进去。</p>

<p>通过查看视图层级发现小红点来源有两种，一种是 tabbar 上的小红点，另一种是 cell 上的小红点。前者是系统 api 带的，后者是微信的 <code>mmbadgeview</code> 类实现的。</p>

<p>微信的 <code>mmtabbarcontroller</code> 继承于 <code>uitabbarcontroller</code>，它提供了几个设置小红点的快捷方法，统统 hook 掉，屏蔽后两个『发现』和『我』上的小红点：</p>

<pre><code>choptimizedmethod2(self, void, mmtabbarcontroller, settabbarbadgeimage, id, arg1, forindex, unsigned int, arg2)

{

    if (arg2 != 2 &amp;&amp; arg2 != 3) {

        chsuper2(mmtabbarcontroller, settabbarbadgeimage, arg1, forindex, arg2);

    }

}



choptimizedmethod2(self, void, mmtabbarcontroller, settabbarbadgestring, id, arg1, forindex, unsigned int, arg2)

{

    if (arg2 != 2 &amp;&amp; arg2 != 3) {

        chsuper2(mmtabbarcontroller, settabbarbadgestring, arg1, forindex, arg2);

    }

}



choptimizedmethod2(self, void, mmtabbarcontroller, settabbarbadgevalue, id, arg1, forindex, unsigned int, arg2)

{

    if (arg2 != 2 &amp;&amp; arg2 != 3) {

        chsuper2(mmtabbarcontroller, settabbarbadgevalue, arg1, forindex, arg2);

    }

}


</code></pre>

<p>去除 <code>mmbadgeview</code> 就更简单了，直接隐藏掉就好了。不直接 remove 的好处是可以保留聊天页面的小红点提醒，而其他页面的小红点被隐藏了。我猜原因是聊天页面的小红点在添加上去后会设置下 <code>hidden = no</code>，因为 cell 是重用的。</p>

<pre><code>choptimizedmethod1(self, void, uiview, didaddsubview, uiview *, subview)

{

    if ([subview iskindofclass:nsclassfromstring(@"mmbadgeview")]) {

        subview.hidden = yes;

    }

}


</code></pre>

<h3 id="a-name----classreference-link----3"><a name="夜间模式 - 辣眼睛" class="reference-link"></a>夜间模式 - 辣眼睛</h3>

<blockquote>

</blockquote>

<p>她说睡了，其实是躺在被窝里继续玩手机罢了。</p>

<p>夜间模式其实也就是主题适配，这个手机 qq 玩的是最 6 的了，无人能敌。要想做一个完美的皮肤引擎是很庞大的工作，不仅是多套色值方案的存储和切换问题，还有多套图片资源的适配问题。这里由于时间仓促，只做了个很辣眼睛的夜间模式，而且切换回来需要杀进程重新进：</p>

<p><img src="/image/make_wechat_great_again/acf2e5d3185b9e35b70a877b45ada0105b4e10e59989195d157eacd87faf9780" alt="" /></p>

<p>这么辣眼睛的审美会被狂吐槽，就不贴代码了，有兴趣的去项目里查看哈哈。</p>

<h3 id="a-name----classreference-link----4"><a name="阻止撤回消息 - 知道真相的我眼泪掉下来" class="reference-link"></a>阻止撤回消息 - 知道真相的我眼泪掉下来</h3>

<p>有时候被撤回的消息看到了会后悔的，但这依然阻止不了我的好奇心+强迫症。</p>

<p>在 『<a href="http://yulingtianxia.com/blog/2016/05/06/let-your-wechat-for-mac-never-revoke-messages/">让你的微信不再被人撤回消息</a>』 里我介绍过用 hopper 逆向的方法。直接看汇编代码来的不那么直接，还是 hook oc 代码稳一些。</p>

<p>撤回消息时会先调用 <code>-[cmessagemgr onrevokemsg:]</code> 方法，然后调用 <code>-[cmessagemgr delmsg:msglist: delall:]</code> 方法删除消息。随意在撤回的时候记录下标志位就好，不影响删除消息功能。</p>

<pre><code>// 阻止撤回消息

choptimizedmethod1(self, void, cmessagemgr, onrevokemsg, id, msg)

{

    [fishconfigurationcenter sharedinstance].revokemsg = yes;

    chsuper1(cmessagemgr, onrevokemsg, msg);

}



chdeclaremethod3(void, cmessagemgr, delmsg, id, arg1, msglist, id, arg2, delall, bool, arg3)

{

    if ([fishconfigurationcenter sharedinstance].revokemsg) {

        [fishconfigurationcenter sharedinstance].revokemsg = no;

    }

    else {

        chsuper3(cmessagemgr, delmsg, arg1, msglist, arg2, delall, arg3);

    }

}


</code></pre>

<h3 id="a-name----classreference-link----5"><a name="要屏蔽 - 不要免打扰" class="reference-link"></a>要屏蔽 - 不要免打扰</h3>

<p>详细内容请见：<a href="http://yulingtianxia.com/blog/2017/03/06/how-to-hook-the-correct-method-in-reverse-engineering">如何在逆向工程中 hook 得更准 - 微信屏蔽好友&amp;群消息实战</a></p>

<h2 id="a-name-classreference-link-1"><a name="后记" class="reference-link"></a>后记</h2>

<p>若不是时间匆忙，或许还可以让微信变得更伟大。比如加个『彻底清理缓存』按钮。平时使用微信确实有很多不爽的地方，尤其是群功能太弱太弱了。我还想加个功能就是如果对方发了超过 30s 的语音，并且对方不是妹子也不是老板不是亲戚，此时自动回复 #&amp;*df@$@(m!…..我没太听清，请你重新再发一遍？</p>

<p>此项目仅用于逆向工程交流学习，黑产死开！</p>

        </article>
        <hr>

        
        
            
            
                
                    
                
                    
                        
                        <h2 id="similar_posts">相关文章</h2>
                        <ul>
                        
                        <li class="relatedPost">
                            <a href="/2017/05/21/runloop_jie_du/">runloop解读
                            
                            </a>
                        </li>
                        
                        
                    
                
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
            
            
        
            
            
        
        
            </ul>
        

        <div class="post-recent">
    <div class="pre">
        
        <p><strong>上一篇</strong> <a href="/2017/05/21/runloop_jie_du/">runloop解读</a></p>
        
    </div>
    <div class="nex">

        
    </div>
</div>


        <h2 id="comments">说一说</h2>
        

<!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript">
var uyan_config = {
     'url':'http://MelonTeam.com/2017/05/25/make_wechat_great_again/',
     'du':'http://MelonTeam.com', 
     'su':'http://MelonTeam.com/2017/05/25/make_wechat_great_again/' 
};
</script>
<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2136610"></script>
<!-- UY END -->






    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    目录
                </div>
                <ul id="content-side" class="content-ul">
                    
                    <li><a href="#similar_posts">相关文章</a></li>
                    
                    <li><a href="#comments">说一说</a></li>
                </ul>
            </div>
            <!-- 其他div框放到这里 -->
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


    <div class="wrapper">

        <p class="description">
            
        </p>
        <p class="contact">
            Contact me at: 
            <a href="https://github.com/MelonTeam" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a>         
            
        </p>
        <p class="power">
            <span>
                Site powered by <a href="https://jekyllrb.com/">Jekyll</a>.
            </span>
            <span>
                Theme designed by <a href="https://github.com/Gaohaoyang">HyG</a>.
            </span>
        </p>
    </div>
</footer>


<script type="text/javascript" src="http://tajs.qq.com/stats?sId=62569168" charset="UTF-8"></script>


    <div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script>
    <script type="text/javascript">
      smoothScroll.init({
        speed: 500, // Integer. How fast to complete the scroll in milliseconds
        easing: 'easeInOutCubic', // Easing pattern to use
        offset: 20, // Integer. How far to offset the scrolling anchor location in pixels
      });
    </script>
    <!-- <script src=" /js/scroll.min.js " charset="utf-8"></script> -->
  </body>

</html>
