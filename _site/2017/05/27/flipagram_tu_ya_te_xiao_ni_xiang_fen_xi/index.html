<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>flipagram 涂鸦特效逆向分析</title>
    <meta name="description" content="  背景  flipagram特效  仿涂鸦特效">

    <link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_8v3czwksspqlg14i.css">
    <link rel="stylesheet" href="/css/main.css ">
    <link rel="canonical" href="http://localhost:4000/2017/05/27/flipagram_tu_ya_te_xiao_ni_xiang_fen_xi/">
    <link rel="alternate" type="application/rss+xml" title="MelonTeam" href="http://localhost:4000/feed.xml ">



</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/" class="brand">MelonTeam</a>
        <small>移动终端前沿技术的探索者</small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/opensource/">
                        
                            <i class="fa fa-folder-open"></i>开源项目
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>归档
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>分类
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tag/">
                        
                            <i class="fa fa-tags"></i>标签
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/board/">
                        
                            <i class="fa fa-pencil"></i>留言板
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" post>
    <div class="left">
        <h1>flipagram 涂鸦特效逆向分析</h1>
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2017-05-27
            </div>
            
            <div class="label-card">
                <i class="fa fa-user"></i>qingduan
            </div>
            
            
            
            <div class="label-card">
            




<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#ios" title="Category: ios" rel="category">ios</a>
    
  

  <!-- <span class="point">•</span> -->
</span>



            </div>
            
            
            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#%E6%B6%82%E9%B8%A6%E7%B2%92%E5%AD%90..." title="Tag: 涂鸦粒子..." rel="tag">涂鸦粒子...</a-->
        <a href="/tag/#涂鸦粒子..." title="Tag: 涂鸦粒子..." rel="tag">涂鸦粒子...</a>
    
  

</span>



            </div>
            

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <ul id="markdown-toc">
  <li><a href="#背景" id="markdown-toc-背景">背景</a></li>
  <li><a href="#flipagram特效" id="markdown-toc-flipagram特效">flipagram特效</a></li>
  <li><a href="#仿涂鸦特效" id="markdown-toc-仿涂鸦特效">仿涂鸦特效</a>    <ul>
      <li><a href="#ios粒子效果" id="markdown-toc-ios粒子效果">ios粒子效果</a></li>
      <li><a href="#flipagram特效参数分析" id="markdown-toc-flipagram特效参数分析">flipagram特效参数分析</a></li>
    </ul>
  </li>
  <li><a href="#逆向分析" id="markdown-toc-逆向分析">逆向分析</a>    <ul>
      <li><a href="#ui层级分析" id="markdown-toc-ui层级分析">ui层级分析</a></li>
      <li><a href="#相关类" id="markdown-toc-相关类">相关类</a></li>
      <li><a href="#小结" id="markdown-toc-小结">小结</a></li>
    </ul>
  </li>
  <li><a href="#后续工作" id="markdown-toc-后续工作">后续工作</a></li>
</ul>

<ul>
  <li>背景</li>
  <li>flipagram特效</li>
  <li>仿涂鸦特效
<!--more-->
    <ul>
      <li>ios粒子效果</li>
      <li>flipagram特效参数分析</li>
    </ul>
  </li>
  <li>逆向分析
    <ul>
      <li>ui层级分析</li>
      <li>相关类</li>
      <li>小结</li>
    </ul>
  </li>
  <li>后续工作</li>
</ul>

<h2 id="背景">背景</h2>

<p>flipagram是美国一款非常火爆的短视频应用，一度登顶美国appstore榜首。前段时间又被今日头条重金收购，被当做今日头条发展海外短视频、提升国际影响力的发力点。本着好奇的心情体验了一下这款app，印象最深的是视频编辑能力比较强，特别是动态涂鸦效果感觉非常惊艳，打算好好研究一下，优化改进一下手q现有的涂鸦效果。</p>

<h2 id="flipagram特效">flipagram特效</h2>

<p><img src="/image/flipagram_tu_ya_te_xiao_ni_xiang_fen_xi/3811bde633bcb0a35390dedea415cca7642b53746ffe82e4004004f189a07899" alt="untitled" /></p>

<h2 id="仿涂鸦特效">仿涂鸦特效</h2>

<p>初步推测：系统自带的粒子效果+手势，在手指移动的过程中创建不同效果的粒子发射机，粒子发射机发射不同效果的粒子。</p>

<h3 id="ios粒子效果">ios粒子效果</h3>

<p>系统自带的粒子效果实现主要的类是：<code class="highlighter-rouge">caemitterbehavior</code>、<code class="highlighter-rouge">caemitterlayer</code>、<code class="highlighter-rouge">caemittercell</code>他们的作用分别是，定义粒子发射机的行为、设置发射机的特征、设置粒子的具体特效。</p>

<p>使用比较简单：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    //create the root layer
    rootlayer = [calayer layer];

    //set the root layer's attributes
    rootlayer.bounds = cgrectmake(0, 0, 640, 480);
    cgcolorref color = cgcolorcreategenericrgb(0.0, 0.0, 0.0, 1);
    rootlayer.backgroundcolor = color;
    cgcolorrelease(color);

    //load the spark image for the particle
    nsimage *image = [nsimage imagenamed:@"tspark"];
    cgimageref img = [image cgimageforproposedrect:nil context:nil hints:nil];

    mortor = [caemitterlayer layer];
    mortor.emitterposition = cgpointmake(320, 0);
    mortor.rendermode = kcaemitterlayeradditive;

    //invisible particle representing the rocket before the explosion
    caemittercell *rocket = [caemittercell emittercell];
    rocket.emissionlongitude = m_pi / 2;
    rocket.emissionlatitude = 0;
    rocket.lifetime = 1.6;
    rocket.birthrate = 1;
    rocket.velocity = 400;
    rocket.velocityrange = 100;
    rocket.yacceleration = -250;
    rocket.emissionrange = m_pi / 4;
    color = cgcolorcreategenericrgb(0.5, 0.5, 0.5, 0.5);
    rocket.color = color;
    cgcolorrelease(color);
    rocket.redrange = 0.5;
    rocket.greenrange = 0.5;
    rocket.bluerange = 0.5;

    //name the cell so that it can be animated later using keypath
    rocket.name = @"rocket";

    //flare particles emitted from the rocket as it flys
    caemittercell *flare = [caemittercell emittercell];
    flare.contents = (__bridge id)img;
    flare.emissionlongitude = (4 * m_pi) / 2;
    flare.scale = 0.4;
    flare.velocity = 100;
    flare.birthrate = 45;
    flare.lifetime = 1.5;
    flare.yacceleration = -350;
    flare.emissionrange = m_pi / 7;
    flare.alphaspeed = -0.7;
    flare.scalespeed = -0.1;
    flare.scalerange = 0.1;
    flare.begintime = 0.01;
    flare.duration = 0.7;

    //the particles that make up the explosion
    caemittercell *firework = [caemittercell emittercell];
    firework.contents = (__bridge id)img;
    firework.birthrate = 9999;
    firework.scale = 0.6;
    firework.velocity = 130;
    firework.lifetime = 2;
    firework.alphaspeed = -0.2;
    firework.yacceleration = -80;
    firework.begintime = 1.5;
    firework.duration = 0.1;
    firework.emissionrange = 2 * m_pi;
    firework.scalespeed = -0.1;
    firework.spin = 2;

    //name the cell so that it can be animated later using keypath
    firework.name = @"firework";

    //prespark is an invisible particle used to later emit the spark
    caemittercell *prespark = [caemittercell emittercell];
    prespark.birthrate = 80;
    prespark.velocity = firework.velocity * 0.70;
    prespark.lifetime = 1.7;
    prespark.yacceleration = firework.yacceleration * 0.85;
    prespark.begintime = firework.begintime - 0.2;
    prespark.emissionrange = firework.emissionrange;
    prespark.greenspeed = 100;
    prespark.bluespeed = 100;
    prespark.redspeed = 100;

    //name the cell so that it can be animated later using keypath
    prespark.name = @"prespark";

    //the 'sparkle' at the end of a firework
    caemittercell *spark = [caemittercell emittercell];
    spark.contents = (__bridge id)img;
    spark.lifetime = 0.05;
    spark.yacceleration = -250;
    spark.begintime = 0.8;
    spark.scale = 0.4;
    spark.birthrate = 10;

    prespark.emittercells = @[spark];
    rocket.emittercells = @[flare, firework, prespark];
    mortor.emittercells = @[rocket];
    [rootlayer addsublayer:mortor];

    //set the view's layer to the base layer
    theview.layer = rootlayer;
    [theview setwantslayer:yes];

    //force the view to update
    [theview setneedsdisplay:yes];
</code></pre>
</div>

<p>具体效果：<br />
<img src="/image/flipagram_tu_ya_te_xiao_ni_xiang_fen_xi/dd892091c4c0d2d508f464cb91746bc4f53fb2e040ab93ad5cf3aa184fe64e53" alt="untitled1" /></p>

<h3 id="flipagram特效参数分析">flipagram特效参数分析</h3>

<p>粒子效果的参数非常多，要实现和flipagram一样的效果，设置参数是一件非常繁琐的事情，借用粒子效果的工具分析了一种类似效果的具体参数，主要包含4个方面的参数：发射机、粒子、色彩、纹理<br />
16个发射机参数(截取部分显示)：<br />
<img src="/image/flipagram_tu_ya_te_xiao_ni_xiang_fen_xi/5fdceb6c5888ff91a17f68a587749e0045b85982ec56918bb72e93b996c4c8d9" alt="屏幕快照 2017-04-28
下午2.05.28" /></p>

<p>10个粒子参数(截取部分显示)：<br />
<img src="/image/flipagram_tu_ya_te_xiao_ni_xiang_fen_xi/453134d07a5a9bf0c70b0f494d2184b2bc725df47909f431b25d1469554da0a1" alt="屏幕快照 2017-04-28
下午2.05.39" /></p>

<p>12个色彩参数(截取部分显示)：<br />
<img src="/image/flipagram_tu_ya_te_xiao_ni_xiang_fen_xi/930b8b3f6ac2a81f3cfe4583765a10072694e8a21fa4ab902174218c7f82ccd1" alt="屏幕快照 2017-04-28
下午2.05.46" /></p>

<p>纹理设置：<br />
<img src="/image/flipagram_tu_ya_te_xiao_ni_xiang_fen_xi/e91dc92d57a0d6e7f730d9894af2c226d0437874a10b3e6dcdbcaf09d8ad5ab6" alt="屏幕快照 2017-04-28
下午2.05.53" /></p>

<p><strong>小结：通过类似粒子效果的参数分析，发现系统接口的参数比较少，根本实现不了这种稍微复杂一点的效果。</strong></p>

<h2 id="逆向分析">逆向分析</h2>

<h3 id="ui层级分析">ui层级分析</h3>

<p>通过分析flipagram的涂鸦页面的ui层级，发现和涂鸦渲染层的类是<code class="highlighter-rouge">fgdrawcontrolsview</code><br />
<img src="/image/flipagram_tu_ya_te_xiao_ni_xiang_fen_xi/42472930a5dd1c25ebba733d1d3a0465503fbe4e6c9c65c9a638e31d0ef127d4" alt="708ff504-d266-4c76-a31a-
e75094aae585" /></p>

<h3 id="相关类">相关类</h3>

<p>通过反汇编分析了和渲染层<code class="highlighter-rouge">fgdrawcontrolsview</code>相关的主要类：<code class="highlighter-rouge">fgdrawenginepathfactory</code>、<code class="highlighter-rouge">fgdrawenginepath</code>、<code class="highlighter-rouge">fgdrawengine</code><br />
<img src="/image/flipagram_tu_ya_te_xiao_ni_xiang_fen_xi/100e7193c51c9bfa5c2dc4b37ffde86ac43bb537e7edd0cdf8cf27f3a646b725" alt="056c8ff2-d711-4faa-ba7f-
8451a4c8966d" /></p>

<p><code class="highlighter-rouge">fgdrawenginepathfactory</code>是一个负责创建具体特效路径的工厂类，比如：烟花效果的路径、不同画刷的路径、表情效果的路径、沙子效果的路径等等。
<code class="highlighter-rouge">fgdrawenginepath</code>设置粒子发射机的特性和粒子特效参数，比如：颜色、画刷参数、弧度等，同时维护了一条路径的矢量点阵信息。
<code class="highlighter-rouge">fgdrawengine</code>内部利用了opengl把发射机参数、粒子效果参数、色彩参数、纹理参数的具体效果渲染出来。</p>

<h3 id="小结">小结</h3>

<p><code class="highlighter-rouge">ios</code>自带的粒子效果使用比较简单，但是效果也比较单一，很难实现酷炫的效果。<code class="highlighter-rouge">flipagram</code>的涂鸦特效实现是在手指移动的过程中创建不同效果的粒子发射机，粒子发射机发射不同效果的粒子。其中<code class="highlighter-rouge">fgdrawenginepath</code>主要负责管理路径和特效信息，<code class="highlighter-rouge">fgdrawengine</code>负责渲染具体的效果。</p>

<h2 id="后续工作">后续工作</h2>

<p>继续分析<code class="highlighter-rouge">fgdrawengine</code>的内部接口，利用<code class="highlighter-rouge">opengl</code>实现一个粒子特效引擎，最终实现<code class="highlighter-rouge">flipagram</code>的涂鸦特效。</p>


        </article>
        <hr>

        
        
            
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
        
            
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
        
        

        <div class="post-recent">
    <div class="pre">
        
        <p><strong>上一篇</strong> <a href="/2017/05/27/kai_fa_zhong_rong_yi_hu_lve_he_wa_keng_de_chang_jing_zong_jie/">开发中容易忽略和挖坑的场景总结</a></p>
        
    </div>
    <div class="nex">

        
        <p><strong>下一篇</strong> <a href="/2017/05/28/guan_yu_gpuimage/">关于gpuimage</a></p>
        
    </div>
</div>


        <h2 id="comments">说一说</h2>
        

<!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript">
var uyan_config = {
     'url':'http://localhost:4000/2017/05/27/flipagram_tu_ya_te_xiao_ni_xiang_fen_xi/',
     'du':'http://localhost:4000', 
     'su':'http://localhost:4000/2017/05/27/flipagram_tu_ya_te_xiao_ni_xiang_fen_xi/' 
};
</script>
<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2136610"></script>
<!-- UY END -->






    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    目录
                </div>
                <ul id="content-side" class="content-ul">
                    
                    <li><a href="#comments">说一说</a></li>
                </ul>
            </div>
            <!-- 其他div框放到这里 -->
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


    <div class="wrapper">

        <p class="description">
            
        </p>
        <p class="contact">
            Contact me at: 
            <a href="https://github.com/MelonTeam" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a>         
            
        </p>
        <p class="power">
            <span>
                Site powered by <a href="https://jekyllrb.com/">Jekyll</a>.
            </span>
            <span>
                Theme designed by <a href="https://github.com/Gaohaoyang">HyG</a>.
            </span>
        </p>
    </div>
</footer>


<script type="text/javascript" src="http://tajs.qq.com/stats?sId=62569168" charset="UTF-8"></script>


    <div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script>
    <script type="text/javascript">
      smoothScroll.init({
        speed: 500, // Integer. How fast to complete the scroll in milliseconds
        easing: 'easeInOutCubic', // Easing pattern to use
        offset: 20, // Integer. How far to offset the scrolling anchor location in pixels
      });
    </script>
    <!-- <script src=" /js/scroll.min.js " charset="utf-8"></script> -->
  </body>

</html>
